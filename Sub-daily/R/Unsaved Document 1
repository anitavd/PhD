# Script that computes the shape parameter of GEV for each grid cell of the uncorrected RR grid

library(evir)
source("/klimadata/applikasjon/gridding/src/iobin.R")
source("/klimadata/applikasjon/gridding/src/met_stat.R")

computeShape <-function(startYear,endYear) {

noYears <- endYear - startYear + 1

ncol <- 1195
nrow <- 1550

#Read file with indexes for non-NA values
filename <- "/home/anitavd/PhD/Sub-daily/RR3/snowmask.bil"
con=file(filename,open="rb")
snowmask=readBin(con,integer(),size=1,n=1550*1195)
close(con)
TabID <- which(snowmask==1)

yearMax <- array(NA,dim=c(length(TabID),noYears))

year.idx <- 1

#Read annual max files for all years
for (year in startYear:endYear) {
	
	filename=sprintf("/home/anitavd/PhD/Sub-daily/RR3/RR3_anMax_%4i.bil",year)
	con=file(filename,open="rb")
	maxgrid=readBin(con,integer(),size=2,n=1195*1550)
    	maxgrid[maxgrid>=10000] <- NA
	maxgrid[maxgrid==-1] <- NA
	yearMax[,year.idx] <- maxgrid
	
	close(con)
	rm(maxgrid)
	gc(reset=TRUE)

	year.idx <- year.idx + 1

} #end year-loop

shape <- array(NA,dim=(length(TabID)))

for (i in 1:length(TabID)) {
print(i)
	if(length(which(yearMax[i,]==0))>2) next()
	shape[i] <- gev.fit(yearMax[i,])$mle[3]   #to get decimals and avoid negative numbers
} #end i-loop

shapeGrid <- array(NA,dim=c(1195,1550))
shapeGrid[TabID] <- round((shape+5)*100,digits=0)   # back to full grid

filename <- "/home/anitavd/PhD/Sub-daily/RR3/shape.RR3"

writebinfile(shapeGrid,paste(filename,".bil",sep=""))

hdrfile <- paste(filename,".hdr",sep="")
blwfile <- paste(filename,".blw",sep="")

system("cp /home/anitavd/GISfile.hdr /home/anitavd/PhD/Sub-daily/RR3/")
system("cp /home/anitavd/GISfile.blw /home/anitavd/PhD/Sub-daily/RR3/")
system(paste("mv /home/anitavd/PhD/Sub-daily/RR3/GISfile.hdr ",hdrfile,sep=""))
system(paste("mv /home/anitavd/PhD/Sub-daily/RR3/GISfile.blw ",blwfile,sep=""))

}
